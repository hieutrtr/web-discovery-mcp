#!/usr/bin/env python3
"""
Usage Example for Story 6.4: High-Level Workflow Orchestration Tools

This script demonstrates how to use the orchestration tools in practice.
It shows the difference between manual tool coordination vs. orchestrated workflows.

Usage:
    python scripts/orchestration_usage_example.py
"""

import asyncio
import sys
from pathlib import Path
from unittest.mock import AsyncMock, MagicMock, patch

# Add the src directory to the path for imports
sys.path.insert(0, str(Path(__file__).parent.parent / "src"))

try:
    from legacy_web_mcp.mcp.server import create_mcp
    from fastmcp import Context
except ImportError as e:
    print(f"‚ùå Import error: {e}")
    print("Please ensure you're running from the project root and dependencies are installed.")
    sys.exit(1)


async def example_manual_workflow():
    """Example of the old manual way - coordinating many individual tools."""
    print("üìù BEFORE Story 6.4 - Manual Tool Coordination")
    print("=" * 60)
    print("To analyze a legacy website, developers had to manually coordinate 15+ tools:")
    print()

    manual_steps = [
        "1. mcp_call discover_website(url='https://old-app.example.com')",
        "2. mcp_call analyze_site_structure(discovered_urls)",
        "3. mcp_call create_workflow(project_id='legacy-analysis')",
        "4. mcp_call analyze_page_list(selected_urls, include_network=True)",
        "5. mcp_call summarize_page_content(url_1, project_id)",
        "6. mcp_call summarize_page_content(url_2, project_id)",
        "7. mcp_call analyze_page_features(url_1, content_1)",
        "8. mcp_call analyze_page_features(url_2, content_2)",
        "9. mcp_call detect_technologies(url_1)",
        "10. mcp_call detect_technologies(url_2)",
        "11. mcp_call control_workflow(workflow_id, 'status')",
        "12. mcp_call generate_documentation(project_id)",
        "13. ... and many more manual steps"
    ]

    for step in manual_steps:
        print(f"   {step}")
        await asyncio.sleep(0.1)  # Simulate processing time

    print()
    print("‚ùå Problems with manual coordination:")
    print("   ‚Ä¢ Required deep knowledge of 15+ individual tools")
    print("   ‚Ä¢ No intelligent workflow planning")
    print("   ‚Ä¢ Manual error handling and recovery")
    print("   ‚Ä¢ No cost optimization")
    print("   ‚Ä¢ Time-consuming setup for each analysis")
    print("   ‚Ä¢ Not suitable for conversational AI interfaces")


async def example_orchestrated_workflow():
    """Example of the new orchestrated way with Story 6.4."""
    print("\nüöÄ AFTER Story 6.4 - Orchestrated Workflow")
    print("=" * 60)
    print("With orchestration tools, the entire workflow is simplified:")
    print()

    # Create mock context and server
    mock_context = AsyncMock(spec=Context)
    server = create_mcp()
    tools = await server.get_tools()

    print("‚ú® Single-command site analysis:")
    print()
    print("   mcp_call analyze_legacy_site(")
    print("       url='https://old-app.example.com',")
    print("       analysis_mode='recommended',")
    print("       include_step2=True,")
    print("       interactive_mode=False")
    print("   )")
    print()

    # Simulate the orchestrated workflow with realistic output
    orchestration_steps = [
        "üîç Phase 1: Discovering site structure...",
        "   ‚Üí Found 47 pages via sitemap analysis",
        "   ‚Üí Selected 18 priority pages for analysis",
        "   ‚Üí Estimated cost: $2.70, time: ~27 minutes",
        "",
        "üß† Phase 2: Planning analysis strategy...",
        "   ‚Üí Mode: recommended (balanced depth and cost)",
        "   ‚Üí Concurrency: 3 browser sessions",
        "   ‚Üí Step 2 analysis: enabled for pages >75% confidence",
        "",
        "‚ö° Phase 3: Executing analysis pipeline...",
        "   ‚Üí Analyzing batch 1/6: 3 pages (10.5s)",
        "   ‚Üí Analyzing batch 2/6: 3 pages (12.1s)",
        "   ‚Üí Analyzing batch 3/6: 3 pages (11.8s)",
        "   ‚Üí Running Step 2 feature analysis on 16 pages",
        "   ‚Üí Completed: 18/18 pages successfully analyzed",
        "",
        "üìã Phase 4: Synthesizing results...",
        "   ‚Üí Technology stack: React 16.8, Express.js, MySQL",
        "   ‚Üí 47 interactive elements identified",
        "   ‚Üí 12 API endpoints discovered",
        "   ‚Üí Modernization priority: Medium (rebuild recommended)",
        "   ‚Üí Documentation generated: /project/docs/analysis_summary.md"
    ]

    for step in orchestration_steps:
        print(f"   {step}")
        await asyncio.sleep(0.2)  # Simulate processing time

    print()
    print("‚úÖ Benefits of orchestrated workflow:")
    print("   ‚Ä¢ Single tool call replaces 15+ manual steps")
    print("   ‚Ä¢ Intelligent site discovery and page prioritization")
    print("   ‚Ä¢ AI-driven analysis strategy optimization")
    print("   ‚Ä¢ Built-in error recovery and retry logic")
    print("   ‚Ä¢ Real-time progress tracking with ETA")
    print("   ‚Ä¢ Cost-aware analysis with transparent usage")
    print("   ‚Ä¢ Perfect for conversational AI interfaces")


async def example_ai_recommendations():
    """Example of AI-driven recommendations feature."""
    print("\nü§ñ AI-Driven Analysis Recommendations")
    print("=" * 60)
    print("The orchestration tools can automatically select optimal analysis strategies:")
    print()

    ai_examples = [
        {
            "site": "Small business website (8 pages)",
            "recommendation": "comprehensive mode, balanced priority",
            "reasoning": "Small site allows thorough analysis within budget"
        },
        {
            "site": "Large e-commerce platform (200+ pages)",
            "recommendation": "recommended mode, cost-efficient priority",
            "reasoning": "Focus on key pages to manage costs while maintaining quality"
        },
        {
            "site": "Legacy enterprise CRM (50 pages)",
            "recommendation": "targeted mode, balanced priority",
            "reasoning": "Complex business logic requires focused analysis"
        }
    ]

    print("   mcp_call analyze_with_recommendations(url='https://example.com')")
    print()

    for example in ai_examples:
        print(f"   üìä {example['site']}:")
        print(f"      ‚Üí AI recommendation: {example['recommendation']}")
        print(f"      ‚Üí Reasoning: {example['reasoning']}")
        print()
        await asyncio.sleep(0.3)


async def example_interactive_mode():
    """Example of interactive mode for human oversight."""
    print("üéØ Interactive Mode for Human Oversight")
    print("=" * 60)
    print("For critical analyses, interactive mode provides checkpoints:")
    print()

    interactive_steps = [
        "üìã **Interactive Mode**: About to analyze 23 pages.",
        "Analysis mode: comprehensive",
        "Cost priority: balanced",
        "Include Step 2: True",
        "Max concurrent: 3",
        "",
        "**Pages to analyze:**",
        "  ‚Ä¢ https://crm.example.com/",
        "  ‚Ä¢ https://crm.example.com/login",
        "  ‚Ä¢ https://crm.example.com/dashboard",
        "  ‚Ä¢ https://crm.example.com/customers",
        "  ‚Ä¢ https://crm.example.com/reports",
        "  ... and 18 more",
        "",
        "‚è≥ Proceeding with analysis in 5 seconds...",
        "",
        "üìä **Phase 3 Complete**: Page analysis finished.",
        "‚úÖ Successfully analyzed: 21 pages",
        "‚ùå Failed: 2 pages (network timeouts)",
        "üî¨ Proceeding to Step 2 feature analysis..."
    ]

    for step in interactive_steps:
        print(f"   {step}")
        await asyncio.sleep(0.2)

    print()
    print("üéõÔ∏è Interactive mode features:")
    print("   ‚Ä¢ Pre-analysis confirmation with cost/time estimates")
    print("   ‚Ä¢ Real-time progress updates every 30 seconds")
    print("   ‚Ä¢ Phase completion summaries")
    print("   ‚Ä¢ User can pause/resume workflows")
    print("   ‚Ä¢ Error reporting with retry options")


async def example_status_tracking():
    """Example of status tracking and progress monitoring."""
    print("\nüìà Status Tracking and Progress Monitoring")
    print("=" * 60)
    print("Monitor ongoing and completed analyses:")
    print()

    print("   mcp_call get_analysis_status(project_id='legacy-crm-analysis')")
    print()

    status_example = {
        "status": "completed",
        "project_id": "legacy-crm-analysis",
        "analysis_files_found": 23,
        "message": "Analysis complete: 23 pages analyzed",
        "last_activity": "2024-01-15 14:30:22"
    }

    print("   üìä Status Response:")
    for key, value in status_example.items():
        print(f"      {key}: {value}")

    print()
    print("üìã Status tracking features:")
    print("   ‚Ä¢ Real-time workflow progress")
    print("   ‚Ä¢ Analysis completion status")
    print("   ‚Ä¢ File and checkpoint tracking")
    print("   ‚Ä¢ Error and retry monitoring")
    print("   ‚Ä¢ Project organization")


async def main():
    """Main demonstration of orchestration tools."""
    print("üé≠ Story 6.4: Orchestration Tools Usage Examples")
    print("=" * 70)
    print("This demo shows the transformation from manual tool coordination")
    print("to intelligent workflow orchestration for legacy website analysis.")
    print()

    try:
        await example_manual_workflow()
        await example_orchestrated_workflow()
        await example_ai_recommendations()
        await example_interactive_mode()
        await example_status_tracking()

        print("\n" + "=" * 70)
        print("üéâ Story 6.4 Implementation Summary")
        print("=" * 70)
        print("‚úÖ Complete workflow orchestration implemented")
        print("‚úÖ 3 new high-level tools added to MCP server:")
        print("   ‚Ä¢ analyze_legacy_site() - Primary orchestration")
        print("   ‚Ä¢ analyze_with_recommendations() - AI strategy selection")
        print("   ‚Ä¢ get_analysis_status() - Progress monitoring")
        print("‚úÖ Intelligent analysis planning and cost optimization")
        print("‚úÖ Interactive and YOLO modes for different use cases")
        print("‚úÖ Comprehensive error handling and recovery")
        print("‚úÖ Real-time progress tracking and user communication")
        print("‚úÖ Seamless integration with existing MCP tool ecosystem")
        print()
        print("üöÄ Ready for Story 6.5: AI-Driven Site Analysis Workflow")
        print("   Next: Natural language processing and site pattern recognition")

    except KeyboardInterrupt:
        print("\n‚èπÔ∏è  Demo interrupted by user")
    except Exception as e:
        print(f"\nüí• Unexpected error during demo: {e}")


if __name__ == "__main__":
    asyncio.run(main())