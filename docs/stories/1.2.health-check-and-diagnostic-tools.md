# Story 1.2: Health Check and Diagnostic Tools

## Status
Ready for Done

## Story
**As a** developer using the MCP server,
**I want** comprehensive health check and diagnostic capabilities,
**so that** I can quickly identify and resolve setup or configuration issues.

## Acceptance Criteria
1. MCP tool `health_check` returns server status, FastMCP state, and dependency availability
2. MCP tool `validate_dependencies` checks Playwright browser installation and reports missing components
3. MCP tool `test_llm_connectivity` validates API keys and connectivity for OpenAI, Anthropic, and Gemini
4. Resource `system_status` provides real-time information about memory usage and active sessions
5. Configuration validator ensures all required environment variables are present and valid
6. Error reporting includes specific remediation steps for common issues

## Tasks / Subtasks
- [x] Implement `health_check` tool reporting server components (AC: 1)
  - [x] Surface FastMCP status, tool registry readiness, and dependency heartbeat (AC: 1)
- [x] Build `validate_dependencies` tool for Playwright checks (AC: 2)
  - [x] Detect installed browsers and missing dependencies with actionable guidance (AC: 2)
- [x] Create `test_llm_connectivity` tool (AC: 3)
  - [x] Perform async calls to OpenAI, Anthropic, Gemini using configured keys and report outcomes (AC: 3)
  - [x] Handle missing keys gracefully while logging remediation hints (AC: 3,6)
- [x] Expose `system_status` resource (AC: 4)
  - [x] Report memory, active sessions, browser contexts based on AsyncIO metrics (AC: 4)
- [x] Add configuration validator executed at startup and on demand (AC: 5)
  - [x] Verify mandatory environment variables and model settings with clear errors (AC: 5,6)
- [x] Standardize error messages with remediation steps in each tool/resource (AC: 6)
  - [x] Use structlog for structured diagnostics and ensure messages surface to MCP clients (AC: 6)

## Dev Notes
- Locate diagnostics in a dedicated module registered through FastMCP to maintain the modular monolith boundaries described in `docs/architecture.md#high-level-architecture`.
- Apply the configuration validation approach from `docs/architecture.md#security` and the pydantic-settings usage in `docs/architecture.md#tech-stack`.
- Use AsyncIO patterns from `docs/architecture.md#architectural-and-design-patterns` to run dependency checks without blocking the event loop.
- Emit structured logs via structlog as specified in `docs/architecture.md#tech-stack`, including contextual metadata for troubleshooting.
- Keep tool/resource responses developer-friendly per the UX expectations in `docs/prd.md#story-12-health-check-and-diagnostic-tools`.

### Testing
- Unit test each diagnostic tool in `tests/unit/tools/test_health.py` style using pytest-asyncio and dependency mocks.
- Integration test via FastMCP client harness in `tests/integration/test_diagnostics.py` to validate JSON-RPC surface.
- Mock external LLM APIs using pytest-httpx to avoid live calls; include failure paths.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-02-14 | 0.1 | Initial draft | John (PM) |
| 2025-09-18 | 0.2 | Implemented diagnostics tools/resources and automated tests | James (Dev) |
| 2025-09-18 | 0.3 | Fix env validation serialization and add regression coverage | James (Dev) |

## Dev Agent Record

### Agent Model Used

gpt-5-codex (Codex CLI)

### Debug Log References

- uv run ruff check
- uv run mypy src tests
- uv run pytest

### Completion Notes List

- Added diagnostic tools/resources (health check, dependency validation, LLM connectivity, system status).
- Implemented configuration validator and supporting async helpers.
- Added unit tests covering diagnostics workflows and helper utilities.
- Patched env validation serialization and added missing-env regression test.

### File List

- src/legacy_web_mcp/config/validator.py
- src/legacy_web_mcp/mcp/diagnostics.py
- src/legacy_web_mcp/mcp/server.py
- tests/unit/mcp/test_diagnostics.py
- docs/stories/1.2.health-check-and-diagnostic-tools.md

## QA Results

