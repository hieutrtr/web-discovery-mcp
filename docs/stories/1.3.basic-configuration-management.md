# Story 1.3: Basic Configuration Management

## Status
Ready for Done

## Story
**As a** developer,
**I want** a straightforward configuration system for the MCP server,
**so that** I can easily set up API keys, preferences, and operational parameters.

## Acceptance Criteria
1. Environment variable support for LLM API keys (OPENAI_API_KEY, ANTHROPIC_API_KEY, GEMINI_API_KEY)
2. Configuration file support for default settings (analysis timeouts, browser preferences, output locations)
3. MCP tool `show_config` displays current configuration without exposing sensitive values
4. Configuration validation with clear error messages for invalid or missing settings
5. Default configuration that works out-of-the-box for basic usage
6. Documentation for all configuration options and their effects

## Tasks / Subtasks
- [x] Implement configuration model using pydantic-settings (AC: 1,2)
  - [x] Map required environment variables and defaults with type validation (AC: 1,2)
  - [x] Support optional `.env` loading and merge with runtime overrides (AC: 1)
- [x] Add configuration file parsing (YAML/JSON) with fallback to defaults (AC: 2,5)
  - [x] Provide sample config file seeded during project setup (AC: 5)
- [x] Create `show_config` MCP tool (AC: 3)
  - [x] Redact sensitive fields while presenting operational settings (AC: 3)
- [x] Integrate validation errors across startup and diagnostic flows (AC: 4)
  - [x] Produce structured error messages reused by health checks (AC: 4)
- [x] Document configuration usage (AC: 6)
  - [x] Update README/config docs describing environment variables and defaults (AC: 6)
- [x] Ensure default configuration works out-of-the-box (AC: 5)
  - [x] Provide baseline values for browser engine, concurrency, output paths (AC: 5)

## Dev Notes
- Centralize configuration module usage across browser, LLM, and storage services per `docs/architecture.md#high-level-architecture` and the Project model in `docs/architecture.md#project`.
- Enforce environment variable validation from `docs/architecture.md#security` so secrets stay out of logs and inputs are sanitized.
- Mirror the storage layout defined in `docs/prd.md#story-15-project-organization-and-file-structure` when setting default output folders.
- Bake in concurrency defaults (3-5 sessions) consistent with `docs/prd.md#non-functional-requirements`.
- Document YOLO vs Interactive configuration toggles to match the workflows planned in `docs/prd.md#epic-5-interactive--yolo-modes-with-user-experience`.

### Testing
- Unit tests in `tests/unit/config/test_settings.py` verifying environment precedence and validation errors using monkeypatch fixtures.
- Integration test ensuring `show_config` tool returns redacted structure with AsyncIO event loop.
- Include regression test covering `.env.template` parity to prevent missing keys.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-02-14 | 0.1 | Initial draft | John (PM) |
| 2025-09-18 | 0.2 | Added configuration settings module, loader, and show_config tool | James (Dev) |
| 2025-09-19 | 0.3 | Automated env checks and added show_config regression coverage | James (Dev) |

## Dev Agent Record

### Agent Model Used

gpt-5-codex (Codex CLI)

### Debug Log References

- uv run ruff check
- uv run ruff check --fix
- uv run mypy src tests
- uv run pytest

### Completion Notes List

- Implemented pydantic-based settings with environment validation and defaults.
- Added YAML/JSON loader with sample `config/default.yaml` and README guidance.
- Registered `show_config` MCP tool and expanded diagnostics coverage.
- Added FastMCP regression test to verify `show_config` redacts sensitive fields automatically.
- Introduced `scripts/check_env.py` CLI to gate deployments and documented its usage.

### File List

- config/default.yaml
- src/legacy_web_mcp/config/__init__.py
- src/legacy_web_mcp/config/env_check.py
- src/legacy_web_mcp/config/loader.py
- src/legacy_web_mcp/config/settings.py
- src/legacy_web_mcp/config/validator.py
- src/legacy_web_mcp/mcp/config_tools.py
- src/legacy_web_mcp/mcp/diagnostics.py
- src/legacy_web_mcp/mcp/server.py
- scripts/diagnostics_client.py
- scripts/check_env.py
- tests/unit/config/test_loader.py
- tests/unit/config/test_env_check.py
- tests/unit/config/test_settings.py
- tests/unit/mcp/test_diagnostics.py
- tests/unit/mcp/test_config_tools.py
- tests/unit/test_project_bootstrap.py
- docs/stories/1.3.basic-configuration-management.md
- README.md

## QA Results

Gate: PASS → docs/qa/gates/1.3-basic-configuration-management.yml
### Review Date: 2025-09-19

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Configuration stack remains cohesive; new FastMCP test covers `show_config` redaction end-to-end, and diagnostics reuse validator remediation without regressions.

### Refactoring Performed

None – QA documentation and gate updates only.

### Compliance Check

- Coding Standards: ✓ – Module layout and typing remain aligned with architecture guidance.
- Project Structure: ✓ – Configuration artefacts stay within `legacy_web_mcp/config` and documented output locations.
- Testing Strategy: ✓ – FastMCP coverage now automates AC3 redaction verification in addition to existing settings, loader, and diagnostics tests.
- All ACs Met: ✓ – Tests exercise all acceptance criteria with defaults functioning out of the box.

### Improvements Checklist

- [x] Automate `show_config` redaction verification via FastMCP (`tests/unit/mcp/test_config_tools.py`).
- [ ] Add CI guard or deployment smoke test to fail when mandatory env keys are absent.
- [ ] Introduce secret-scanning or schema guardrails for YAML overrides to prevent committed API keys.

### Security Review

Secrets stay redacted through `display_dict`; outstanding risk is storing keys in committed config overrides, mitigated with documentation but still worth tooling support.

### Performance Considerations

Configuration loading still performs in-memory merges over small YAML/JSON files; monitor if future stories expand config footprint or reload frequency.

### Files Modified During Review

- docs/qa/gates/1.3-basic-configuration-management.yml
- docs/qa/assessments/1.3-trace-20250919.md

### Gate Status

Gate: PASS → docs/qa/gates/1.3-basic-configuration-management.yml
Risk profile: docs/qa/assessments/1.3-risk-20250918.md
NFR assessment: docs/qa/assessments/1.3-nfr-20250918.md
Trace matrix: docs/qa/assessments/1.3-trace-20250919.md

### Recommended Status

✓ Ready for Done
