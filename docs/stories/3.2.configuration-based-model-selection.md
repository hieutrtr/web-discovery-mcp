# Story 3.2: Configuration-Based Model Selection

## Status
Approved

## Story
**As a** developer,
**I want** to configure LLM model selection through environment variables,
**so that** I can control analysis costs and model usage without complex logic.

## Acceptance Criteria
1. Environment variable configuration for default models: `STEP1_MODEL`, `STEP2_MODEL`, `FALLBACK_MODEL`
2. Provider-specific model mapping (e.g., `STEP1_MODEL=gpt-5-nano`, `STEP2_MODEL=claude-3.7-sonnet`)
3. Simple fallback chain when primary model fails: primary → fallback → error
4. Configuration validation ensuring specified models are available for configured providers
5. Usage tracking showing which models were used for each page analysis
6. Cost calculation based on configured models and actual token usage
7. Basic budget monitoring with configurable monthly spending alerts via environment variables

## Tasks / Subtasks
- [ ] Extend configuration model (Story 1.3) with STEP1/STEP2/FALLBACK model variables and defaults (AC: 1)
- [ ] Implement provider-specific mapping registry resolving logical names to provider identifiers (AC: 2)
- [ ] Wire fallback chain in LLM engine leveraging provider adapters from Story 3.1 (AC: 3)
- [ ] Validate configured models exist for enabled providers during startup and diagnostics (AC: 4)
- [ ] Record model usage per page analysis and expose metrics for progress/reporting layers (AC: 5)
- [ ] Calculate per-page and session costs using token usage data captured in Story 3.1 (AC: 6)
- [ ] Add budget alert thresholds configurable via environment variables with notifications surfaced to progress tracking (AC: 7)

## Dev Notes
- Build on the configuration system in `docs/stories/1.3.basic-configuration-management.md` ensuring environment precedence.
- Document model mapping options referencing `docs/prd.md#story-32-configuration-based-model-selection` for developer clarity.
- Use cost tracking expectations defined in `docs/architecture.md#llm-integration-engine` and `docs/architecture.md#security` for secret handling.
- Emit budget alerts through progress notifications that link to telemetry in `docs/prd.md#epic-4-progress-tracking--documentation-generation`.
- Ensure fallback logic aligns with provider facade pattern in `docs/architecture.md#architectural-and-design-patterns`.

### Testing
- Unit test configuration parsing and validation with monkeypatched environment variables.
- Simulate provider availability scenarios verifying fallback path coverage with async tests.
- Test budget alert triggers using controlled token usage data to ensure notifications fire correctly.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-02-14 | 0.1 | Initial draft | John (PM) |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results

Gate: PASS → docs/qa/gates/3.2-configuration-based-model-selection.yml
