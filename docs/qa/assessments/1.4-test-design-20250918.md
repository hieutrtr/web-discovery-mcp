# Test Design: Story 1.4

Date: 2025-09-18
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 14
- Unit tests: 6 (43%)
- Integration tests: 7 (50%)
- E2E tests: 1 (7%)
- Priority distribution: P0: 8, P1: 5, P2: 1, P3: 0

## Test Scenarios by Acceptance Criteria

### AC1: MCP tool `discover_website` accepts URL input and returns organized site structure

| ID             | Level       | Priority | Test                                                                                     | Justification |
| -------------- | ----------- | -------- | ---------------------------------------------------------------------------------------- | ------------- |
| 1.4-UNIT-001   | Unit        | P0       | Validate URL sanitization and normalization helper rejects unsupported schemes/domains  | Pure validation logic; fail-fast before I/O |
| 1.4-INT-001    | Integration | P0       | Invoke `discover_website` with mocked services and assert structured site map output     | Confirms tool wiring and aggregation of downstream modules |

### AC2: Automatic sitemap parsing with resilient error handling

| ID             | Level       | Priority | Test                                                                                     | Justification |
| -------------- | ----------- | -------- | ---------------------------------------------------------------------------------------- | ------------- |
| 1.4-UNIT-002   | Unit        | P0       | Parse sitemap XML (nested indexes) ensuring deduped URL set and metadata extraction      | Core algorithmic logic without I/O |
| 1.4-UNIT-003   | Unit        | P0       | Simulate missing/invalid sitemap and assert graceful failure response + fallback flag    | Error handling branch in parser module |
| 1.4-INT-002    | Integration | P0       | Pipeline fetches sitemap over HTTP mock; validates retry + fallback path on 404/timeout  | Cross-module robustness for critical discovery path |

### AC3: Robots.txt analysis enforcing crawl directives

| ID             | Level       | Priority | Test                                                                                     | Justification |
| -------------- | ----------- | -------- | ---------------------------------------------------------------------------------------- | ------------- |
| 1.4-UNIT-004   | Unit        | P0       | Parse robots.txt rules (allow/disallow, wildcards) to produce normalized policy objects   | Deterministic parsing logic |
| 1.4-INT-003    | Integration | P0       | Combine robots analysis with sitemap crawl list, ensuring forbidden paths excluded       | Validates interaction between policy enforcement and URL inventory |

### AC4: Manual crawling fallback with depth limits

| ID             | Level       | Priority | Test                                                                                     | Justification |
| -------------- | ----------- | -------- | ---------------------------------------------------------------------------------------- | ------------- |
| 1.4-INT-004    | Integration | P1       | Execute fallback BFS crawl against mocked site, asserting depth limit and dedupe behavior | Requires async crawling + queue coordination across modules |

### AC5: URL categorization and filtering

| ID             | Level       | Priority | Test                                                                                     | Justification |
| -------------- | ----------- | -------- | ---------------------------------------------------------------------------------------- | ------------- |
| 1.4-UNIT-005   | Unit        | P1       | Classify URLs (page vs asset) using content-type heuristics and extension rules           | Pure classification logic with multiple branches |
| 1.4-INT-005    | Integration | P1       | Full pipeline removes external/asset URLs and annotates internal pages with tags         | Ensures categorizer result integrated into inventory |

### AC6: Persist URL inventory with metadata snapshot

| ID             | Level       | Priority | Test                                                                                     | Justification |
| -------------- | ----------- | -------- | ---------------------------------------------------------------------------------------- | ------------- |
| 1.4-UNIT-006   | Unit        | P1       | Validate inventory serialization schema (titles, descriptions, complexity scores)         | Data model verification without I/O |
| 1.4-INT-006    | Integration | P1       | Tool writes inventory JSON/YAML to project directory; verify file path and schema        | Verifies storage abstraction + configuration defaults |

### AC7: Progress reporting during discovery

| ID             | Level       | Priority | Test                                                                                     | Justification |
| -------------- | ----------- | -------- | ---------------------------------------------------------------------------------------- | ------------- |
| 1.4-INT-007    | Integration | P2       | Capture streaming progress notifications across multi-page crawl and assert granularity  | Observes async progress emitter interacting with MCP context |

### Cross-AC End-to-End Confidence

| ID             | Level | Priority | Test                                                                                          | Justification |
| -------------- | ----- | -------- | --------------------------------------------------------------------------------------------- | ------------- |
| 1.4-E2E-001    | E2E   | P0       | Run `discover_website` against a controlled static site fixture exercising sitemap + fallback | Validates complete pipeline, ensuring outputs match expected inventory artifacts |

## Risk Coverage

- P0 tests guard critical discovery correctness, compliance (robots.txt), and data persistence.
- Integration coverage ensures async orchestration, retry logic, and storage side effects behave under failure scenarios.
- E2E test mitigates risk of integration regressions by validating full workflow over representative site topology.

## Recommended Execution Order

1. P0 unit tests (1.4-UNIT-001 → 1.4-UNIT-004)
2. P0 integration tests (1.4-INT-001 → 1.4-INT-003) and E2E smoke (1.4-E2E-001)
3. Remaining P1 unit/integration tests (1.4-INT-004, 1.4-UNIT-005, 1.4-INT-005, 1.4-UNIT-006, 1.4-INT-006)
4. P2 progress coverage (1.4-INT-007) as part of regression or extended suites

## Gate Summary

```yaml
test_design:
  scenarios_total: 14
  by_level:
    unit: 6
    integration: 7
    e2e: 1
  by_priority:
    p0: 8
    p1: 5
    p2: 1
    p3: 0
  coverage_gaps: []
```

## Trace References

Test design matrix: docs/qa/assessments/1.4-test-design-20250918.md
P0 tests identified: 8
