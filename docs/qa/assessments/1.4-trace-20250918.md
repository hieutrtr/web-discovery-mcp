# Requirements Traceability Matrix

## Story: 1.4 - URL Discovery and Sitemap Parsing

### Coverage Summary

- Total Requirements: 7
- Fully Covered: 0 (0%)
- Partially Covered: 0 (0%)
- Not Covered: 7 (100%)

### Requirement Mappings

#### AC1: MCP tool `discover_website` accepts URL input and returns organized site structure

- **Coverage:** NONE
- **Existing Tests:** _None implemented_
- **Planned Validation:**
  - `tests/unit/discovery/test_url_validation.py::test_normalize_root_url` (planned – from scenario 1.4-UNIT-001)
    - Given: A set of user-provided URLs with mixed schemes and trailing paths
    - When: The URL sanitization helper normalizes the input
    - Then: The resulting root URL uses HTTPS (if available) and strips unsupported schemes
  - `tests/integration/mcp/test_discover_website.py::test_returns_structured_inventory` (planned – scenario 1.4-INT-001)
    - Given: Mocked sitemap/robots/crawler services returning deterministic data
    - When: `discover_website` executes with a valid URL
    - Then: The response payload contains grouped page structures ready for selection

#### AC2: Automatic sitemap parsing and fallback handling

- **Coverage:** NONE
- **Existing Tests:** _None implemented_
- **Planned Validation:**
  - `tests/unit/discovery/test_sitemap_parser.py::test_parse_nested_sitemaps` (planned – 1.4-UNIT-002)
    - Given: A sitemap index referencing nested sitemaps
    - When: The parser processes the tree
    - Then: A flattened, deduped URL set with metadata is produced
  - `tests/unit/discovery/test_sitemap_parser.py::test_missing_sitemap_triggers_fallback` (planned – 1.4-UNIT-003)
    - Given: A 404/timeout from sitemap endpoint
    - When: The parser runs
    - Then: It reports fallback required without raising and records an error event
  - `tests/integration/discovery/test_sitemap_fetcher.py::test_retry_and_fallback` (planned – 1.4-INT-002)
    - Given: HTTP client returning retryable errors and then 404
    - When: The downloader executes with retry policy
    - Then: Retries occur, failure is logged, and fallback crawling is enabled

#### AC3: Robots.txt analysis honoring directives

- **Coverage:** NONE
- **Existing Tests:** _None implemented_
- **Planned Validation:**
  - `tests/unit/discovery/test_robots_parser.py::test_allow_disallow_rules` (planned – 1.4-UNIT-004)
    - Given: Robots file with overlapping allow/disallow patterns
    - When: The parser runs
    - Then: It produces normalized rules with correct precedence
  - `tests/integration/discovery/test_policy_enforcement.py::test_excludes_disallowed_urls` (planned – 1.4-INT-003)
    - Given: Combined sitemap + robots inputs
    - When: The pipeline merges them
    - Then: URLs disallowed by robots are excluded from discovery results

#### AC4: Manual crawling fallback with depth limits

- **Coverage:** NONE
- **Existing Tests:** _None implemented_
- **Planned Validation:**
  - `tests/integration/discovery/test_manual_crawler.py::test_bounded_depth_bfs` (planned – 1.4-INT-004)
    - Given: Mocked site graph with multiple depth levels
    - When: The fallback crawler runs with max depth N
    - Then: Only nodes within depth N are visited and duplicates avoided

#### AC5: URL categorization and filtering

- **Coverage:** NONE
- **Existing Tests:** _None implemented_
- **Planned Validation:**
  - `tests/unit/discovery/test_url_classifier.py::test_classify_assets_vs_pages` (planned – 1.4-UNIT-005)
    - Given: URLs with various extensions and content types
    - When: The classifier evaluates them
    - Then: Asset URLs are flagged and excluded, internal pages tagged appropriately
  - `tests/integration/discovery/test_inventory_filters.py::test_removes_external_and_assets` (planned – 1.4-INT-005)
    - Given: Mixed internal/external URL set
    - When: The pipeline filters results
    - Then: Only internal page URLs remain with proper annotations

#### AC6: Persist URL inventory with metadata

- **Coverage:** NONE
- **Existing Tests:** _None implemented_
- **Planned Validation:**
  - `tests/unit/storage/test_inventory_model.py::test_inventory_serialization` (planned – 1.4-UNIT-006)
    - Given: Inventory data model instance with metadata
    - When: Serialized to JSON/YAML
    - Then: Output schema matches spec with titles, descriptions, complexity scores
  - `tests/integration/storage/test_inventory_persistence.py::test_inventory_written_to_project_folder` (planned – 1.4-INT-006)
    - Given: Project root path configuration
    - When: Discovery saves inventory
    - Then: Files are created in expected directories with correct contents

#### AC7: Progress reporting during discovery

- **Coverage:** NONE
- **Existing Tests:** _None implemented_
- **Planned Validation:**
  - `tests/integration/mcp/test_progress_notifications.py::test_streams_progress_updates` (planned – 1.4-INT-007)
    - Given: Multi-page crawl scenario
    - When: Discovery runs via MCP context
    - Then: Progress events emit at start, per-page, and completion with percentages
  - `tests/e2e/test_discover_workflow.py::test_full_discovery_flow` (planned – 1.4-E2E-001)
    - Given: Controlled static site fixture
    - When: User invokes discovery via CLI/MCP client
    - Then: Progress updates stream and final inventory/report files exist

### Critical Gaps

1. **Absence of Automated Coverage**
   - Gap: No tests currently cover any acceptance criteria.
   - Risk: High – regression risk across discovery pipeline.
   - Action: Implement planned unit/integration/e2e tests from test design matrix, prioritizing P0 scenarios.

2. **Cross-story Contract Assurance**
   - Gap: No verification that Story 1.4 outputs align with Story 1.5 storage expectations.
   - Risk: Medium – may break downstream project organization.
   - Action: Add integration test with storage module once Story 1.5 implemented.

### Test Design Recommendations

- Execute P0 scenarios first (URL validation, sitemap parsing, robots enforcement, persistence).
- Introduce fixture libraries for static sites and HTTP responses to keep integration tests deterministic.
- Use asyncio test utilities (`pytest-asyncio`) to drive the asynchronous discovery pipeline.
- Capture and assert structlog output for error-handling scenarios to guarantee observability.

### Risk Assessment

- **High Risk:** AC1–AC3, AC6 (no coverage; critical to discovery accuracy and compliance).
- **Medium Risk:** AC4, AC5, AC7 (operational usability and user experience depend on these paths).
- **Low Risk:** None until tests exist.

---

Trace matrix: docs/qa/assessments/1.4-trace-20250918.md
